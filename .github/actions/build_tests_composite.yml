name: Build HIL tests (composite)
description: Checkout, install toolchains, build tests for a SoC, upload artifact
inputs:
  event_name:      { description: github.event_name, required: true }
  repository:      { description: owner/repo for workflow_dispatch, required: true }
  ref_sha:         { description: commit SHA (optional), required: false, default: "" }
  branch:          { description: branch/tag to checkout if no SHA, required: true }
  soc:             { description: SoC (e.g. esp32c3), required: true }
  rust_target:     { description: rust target triple, required: true }

runs:
  using: composite
  steps:
    - uses: actions/checkout@v4
      if: ${{ inputs.event_name == 'merge_group' }}
    - uses: actions/checkout@v4
      if: ${{ inputs.event_name == 'workflow_dispatch' }}
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.ref_sha != '' && inputs.ref_sha || inputs.branch }}

    - if: ${{ !contains(fromJson('["esp32","esp32s2","esp32s3"]'), inputs.soc) }}
      uses: dtolnay/rust-toolchain@v1
      with:
        target: ${{ inputs.rust_target }}
        toolchain: stable
        components: rust-src

    - if: ${{ !contains(fromJson('["esp32","esp32s2","esp32s3"]'), inputs.soc) }}
      name: Install nightly Rust toolchain
      uses: dtolnay/rust-toolchain@v1
      with:
        target: ${{ inputs.rust_target }}
        toolchain: nightly
        components: rust-src

    - if: ${{ contains(fromJson('["esp32","esp32s2","esp32s3"]'), inputs.soc) }}
      uses: esp-rs/xtensa-toolchain@v1.6
      with:
        buildtargets: ${{ inputs.soc }}
        default: true
        version: 1.90.0.0

    - name: Build tests
      shell: bash
      run: cargo xtask build tests ${{ inputs.soc }}

    - uses: actions/upload-artifact@v4
      with:
        name: tests-${{ inputs.soc }}
        path: ${{ github.workspace }}/target/tests/${{ inputs.soc }}
        if-no-files-found: error
        overwrite: true
