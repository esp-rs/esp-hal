name: Build HIL tests (composite)
description: Checkout, install toolchains, build tests for a SoC, upload artifact
inputs:
  event_name:      { description: github.event_name, required: true }
  repository:      { description: owner/repo for workflow_dispatch, required: true }
  branch:          { description: branch/tag to checkout if no SHA, required: true }
  soc:             { description: SoC (e.g. esp32c3), required: true }
  rust_target:     { description: rust target triple, required: true }
  tests:           { description: "Optional comma-separated test names", required: false, default: "" }

runs:
  using: composite
  steps:
    - uses: actions/checkout@v4
      if: ${{ inputs.event_name == 'merge_group' }}
    - uses: actions/checkout@v4
      if: ${{ inputs.event_name == 'workflow_dispatch' }}
      with:
        repository: ${{ inputs.repository }}
        ref: ${{ inputs.branch }}

    - if: ${{ !contains(fromJson('["esp32","esp32s2","esp32s3"]'), inputs.soc) }}
      uses: dtolnay/rust-toolchain@v1
      with:
        target: ${{ inputs.rust_target }}
        toolchain: stable
        components: rust-src

    - if: ${{ !contains(fromJson('["esp32","esp32s2","esp32s3"]'), inputs.soc) }}
      name: Install nightly Rust toolchain
      uses: dtolnay/rust-toolchain@v1
      with:
        target: ${{ inputs.rust_target }}
        toolchain: nightly
        components: rust-src

    - if: ${{ contains(fromJson('["esp32","esp32s2","esp32s3"]'), inputs.soc) }}
      uses: esp-rs/xtensa-toolchain@v1.6
      with:
        buildtargets: ${{ inputs.soc }}
        default: true
        version: 1.92.0.0

    - name: Build tests
      shell: bash
      run: |
        if [ -n "${{ inputs.tests }}" ]; then
          echo "Building selected tests for ${{ inputs.soc }}: ${{ inputs.tests }}"
          cargo xtask build tests ${{ inputs.soc }} --tests "${{ inputs.tests }}"
        else
          echo "Building ALL tests for ${{ inputs.soc }}"
          cargo xtask build tests ${{ inputs.soc }}
        fi

    - uses: actions/upload-artifact@v4
      with:
        name: tests-${{ inputs.soc }}
        path: ${{ github.workspace }}/target/tests/${{ inputs.soc }}
        if-no-files-found: error
        overwrite: true
