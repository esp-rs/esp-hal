name: HIL (slash)

on:
  issue_comment:
    types: [created, edited]

permissions:
  actions: write
  pull-requests: write
  contents: read

jobs:
  auth:
    # Only PR comments need auth
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
    steps:
      - id: check
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const commenter = context.payload.comment.user.login.toLowerCase();
            const pr = context.payload.issue.number;
            // Maintainers are always allowed
            if (assoc === 'MEMBER' || assoc === 'OWNER') {
              core.setOutput('allowed', 'true');
              return;
            }
            // Otherwise, look for the per-PR trust list comment
            const header = '### [HIL trust list]';
            let allowed = false;
            const { owner, repo } = context.repo;
            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number: pr, per_page: 100 }
            );
            const trust = comments.find(c =>
              c.user?.login === 'github-actions[bot]' &&
              typeof c.body === 'string' &&
              c.body.startsWith(header)
            );
            if (trust) {
              try {
                const json = trust.body.split('\n').slice(1).join('\n');
                const list = (JSON.parse(json).trusted || []).map(s => String(s).toLowerCase());
                allowed = list.includes(commenter);
              } catch (e) {
                // ignore parse errors -> not allowed
              }
            }
            core.setOutput('allowed', allowed ? 'true' : 'false');
  hil-quick:
    # check every PR comment, check correct role, and explicitly look for '/hil quick'
    if: ${{ github.event.issue.pull_request && ( github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER' ) && startsWith(github.event.comment.body, '/hil quick') }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch HIL (quick)
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: .github/workflows/hil.yml
          inputs: |
            {
              "repository": "${{ github.repository }}",
              "branch": "refs/pull/${{ github.event.issue.number }}/head",
              "matrix": "quick"
            }

      - name: Confirm in PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: >
            Triggered quick HIL run for
            #${{ github.event.issue.number }}

  hil-full:
    # check every PR comment, check correct role, and explicitly look for '/hil full'
    if: ${{ github.event.issue.pull_request && ( github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER' ) && startsWith(github.event.comment.body, '/hil full') }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch HIL (full)
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: .github/workflows/hil.yml
          inputs: |
            {
              "repository": "${{ github.repository }}",
              "branch": "refs/pull/${{ github.event.issue.number }}/head",
              "matrix": "full"
            }

      - name: Confirm in PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: >
            Triggered full HIL run for
            #${{ github.event.issue.number }}.

  hil-help:
    # If it's a PR comment that starts with '/hil' but not the two valid forms
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/hil') && !startsWith(github.event.comment.body, '/hil quick') && !startsWith(github.event.comment.body, '/hil full') }}
    runs-on: ubuntu-latest
    steps:
      - name: Explain usage
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Usage:
            - `/hil quick` — run a smoke/quick HIL matrix
            - `/hil full` — run the full HIL matrix
            _(Only repository members/collaborators can trigger runs.)_
