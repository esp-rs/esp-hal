name: HIL (slash)

on:
  issue_comment:
    types: [created, edited]

permissions:
  actions: write
  pull-requests: write
  contents: read

jobs:
  hil-quick:
    # check every PR comment, check correct role, and explicitly look for '/hil quick'
    if: ${{ github.event.issue.pull_request && ( github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER' ) && startsWith(github.event.comment.body, '/hil quick') }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch HIL (quick)
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: .github/workflows/hil.yml
          inputs: |
            {
              "repository": "${{ github.repository }}",
              "branch": "refs/pull/${{ github.event.issue.number }}/head",
              "matrix": "quick"
            }

      - name: Confirm in PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: >
            Triggered quick HIL run for
            #${{ github.event.issue.number }}

  hil-full:
    # check every PR comment, check correct role, and explicitly look for '/hil full'
    if: ${{ github.event.issue.pull_request && ( github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'OWNER' ) && startsWith(github.event.comment.body, '/hil full') }}
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch HIL (full)
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: .github/workflows/hil.yml
          inputs: |
            {
              "repository": "${{ github.repository }}",
              "branch": "refs/pull/${{ github.event.issue.number }}/head",
              "matrix": "full"
            }

      - name: Confirm in PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: >
            Triggered full HIL run for
            #${{ github.event.issue.number }}.

  hil-help:
    # If it's a PR comment that starts with '/hil' but not the two valid forms
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/hil') && !startsWith(github.event.comment.body, '/hil quick') && !startsWith(github.event.comment.body, '/hil full') }}
    runs-on: ubuntu-latest
    steps:
      - name: Explain usage
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Usage:
            - `/hil quick` — run a smoke/quick HIL matrix
            - `/hil full` — run the full HIL matrix
            _(Only repository members/collaborators can trigger runs.)_
