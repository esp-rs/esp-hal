name: HIL Test

on:
  merge_group:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        device: [
            # Xtensa targets:
            {
              chip: "esp32",
              target: "xtensa-esp32-none-elf",
            },
            {
              chip: "esp32s2",
              target: "xtensa-esp32s2-none-elf",
            },
            {
              chip: "esp32s3",
              target: "xtensa-esp32s3-none-elf",
            },

            # RISC-V targets:
            {
              chip: "esp32c2",
              target: "riscv32imc-unknown-none-elf",
            },
            {
              chip: "esp32c3",
              target: "riscv32imc-unknown-none-elf",
            },
            {
              chip: "esp32c6",
              target: "riscv32imac-unknown-none-elf",
            },
            {
              chip: "esp32h2",
              target: "riscv32imac-unknown-none-elf",
            },
          ]

    steps:
      - uses: actions/checkout@v3

      - if: startsWith(matrix.device.target, 'riscv32')
        uses: dtolnay/rust-toolchain@v1
        with:
          target: ${{ matrix.device.target }}
          toolchain: nightly
      - if: startsWith(matrix.device.target, 'xtensa')
        uses: esp-rs/xtensa-toolchain@v1.5.2
        with:
          ldproxy: false
          override: false

      - uses: Swatinem/rust-cache@v2

      - name: Build test binaries
        env:
          CARGO_BUILD_TARGET: ${{ matrix.device.target }}
        run: |
          cd hil-test/
          cargo build --release --target=${{ matrix.device.target }} --features=${{ matrix.device.chip }}

  # Test Xtensa targets:

  # TODO: Add jobs for Xtensa once supported by `probe-rs`

  # Test RISC-V targets:

  test-esp32c2:
    needs: build-tests
    runs-on:
      labels: [self-hosted, esp32c2]

    steps:
      - name: Run tests on-device
        env:
          PROBE_RS_CHIP: esp32c2
        run: |
          # ...

  test-esp32c3:
    needs: build-tests
    runs-on:
      labels: [self-hosted, esp32c3]

    steps:
      - name: Run tests on-device
        env:
          PROBE_RS_CHIP: esp32c3
        run: |
          # ...

  test-esp32c6:
    needs: build-tests
    runs-on:
      labels: [self-hosted, esp32c6]

    steps:
      - name: Run tests on-device
        env:
          PROBE_RS_CHIP: esp32c6
        run: |
          # ...

  test-esp32h2:
    needs: build-tests
    runs-on:
      labels: [self-hosted, esp32h2]

    steps:
      - name: Run tests on-device
        env:
          PROBE_RS_CHIP: esp32h2
        run: |
          # ...
